# 算法原理与性能优化说明文档

本文件解释了第四阶段采用的核心算法原理及 Spark 性能调优技术，为毕业论文提供理论基础。

---

## 1. K-Means 聚类算法

### 1.1 基本原理
K-Means 是一种基于距离的无监督学习算法。其核心目标是将 $N$ 个观测值划分为 $K$ 个聚类，使得每个观测值属于离其均值（聚类中心）最近的聚类。

### 1.2 关键处理步骤
1. **对数变换 (Log Transformation)**：由于 Monetary (消费金额) 等指标通常呈长尾分布，通过对数变换可以压缩偏度，使数据更接近正态分布，提高聚类效果。
2. **标准化 (Feature Scaling)**：使用 `StandardScaler` 将 R/F/M 三个维度的数值缩放到相同的量纲（均值为0，标准差为1），防止大数值特征主导距离计算。
3. **肘部法 (Elbow Method)**：通过计算不同 $K$ 值下的 WSSSE（误差平方和）并寻找折点，科学确定最佳聚类数。

---

## 2. 数据倾斜治理 (Data Skew Optimization)

### 2.1 什么是数据倾斜
在大数据处理中，如果某个 Key（如 Top 品牌 "Apple"）的数据量远大于其他 Key，会导致该 Key 对应的 Task 运行时间极长，成为整个作业的瓶颈（Straggler）。

### 2.2 治理策略
1. **两阶段聚合 (Two-Stage Aggregation)**：
    - **第一阶段 (局部聚合)**：给 Key 加上随机后缀（盐），打散原本倾斜的 Key，使其分布到多个 Partition 进行局部聚合。
    - **第二阶段 (全局聚合)**：去掉随机后缀，对第一阶段的结果进行最终汇总。
2. **广播连接 (Broadcast Join)**：
    - 当一个大表与一个小表（如品牌维表）关联时，将小表广播到所有 Executor 节点，避免大规模 Shuffle 带来的数据传输和倾斜风险。

---

## 3. 性能调优参数
- `spark.sql.shuffle.partitions`: 根据数据规模（100GB+）动态调整 Shuffle 分区数，通常设为 CPU 总核数的 2-3 倍。
- `spark.sql.autoBroadcastJoinThreshold`: 设置自动触发广播连接的阈值。
